(this["webpackJsonpkapwing-client"]=this["webpackJsonpkapwing-client"]||[]).push([[17],{1668:function(e,t,r){"use strict";r.r(t);var n=r(202),a=r(2),i=r(4),o=r.n(i),s=r(10),u=r(8),c=r(9),d=r(11),l=r(12),p=r(13),b=r(3),f=r.n(b),v=r(16),m=r(20),h=r(35),y=r.n(h),x=r(306),k=r.n(x),L=r(69),I=r.n(L),O=r(188),g=r(58),w=r(17),_=r(14),D=r(109),j=r(100),A=r(113),z=r(215),P=r(25),U=r(68),F=r(65),C=r(283),E=r(53),R=r(72),S=r(86),M=r(74),V=r(255),T=function(e){Object(l.a)(r,e);var t=Object(p.a)(r);function r(){var e;Object(c.a)(this,r);for(var i=arguments.length,d=new Array(i),l=0;l<i;l++)d[l]=arguments[l];return(e=t.call.apply(t,[this].concat(d))).intervalId=void 0,e.monitorIntervals={},e.pendingDownloads={},e.pendingReuploads={},e.pendingOptimizations={},e.frameCacheWorkers={},e.assetInDb={},e.numFetchesInProgress=0,e.monitorAssets=Object(u.a)(o.a.mark((function t(){var r,n,a,i,c,d,l,p,b,f;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,r=e.props,n=r.isStudio,a=r.scenes,i=r.audio,!n){t.next=13;break}c=Object(s.a)(a);try{for(c.s();!(d=c.n()).done;){l=d.value,p=Object(s.a)(l.layers);try{for(p.s();!(b=p.n()).done;)f=b.value,e.monitorIntervals[f.id]||(e.monitorIntervals[f.id]=0),e.updateLayerAssets(f)}catch(v){p.e(v)}finally{p.f()}}}catch(v){c.e(v)}finally{c.f()}return t.next=7,O.getPendingConversions();case 7:return t.sent.forEach((function(t){var r=t.name,n=t.id,a=t.conversion_id,i=t.mediaLibraryID;e.updateLayerAssets({mediaLibraryID:i,name:r,id:n,conversion_id:a})})),t.next=11,O.getPendingUploads();case 11:t.sent.forEach(function(){var t=Object(u.a)(o.a.mark((function t(r){var n,a,i,s,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=r.mediaLibraryID,a=r.asset_id,10!==(i=r.retryNumber)){t.next=6;break}return t.next=4,O.deletePendingUpload(n);case 4:t.next=18;break;case 6:return t.next=8,Object(D.d)(a);case 8:if((s=t.sent).status!==_.c.uploaded){t.next=16;break}return u=s.url,e.props.updateMediaLibraryLayer({mediaLibraryID:n,url:u}),t.next=14,O.deletePendingUpload(n);case 14:t.next=18;break;case 16:return t.next=18,O.updatePendingUpload(n,{retryNumber:i+1});case 18:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 13:i&&!I()(i)&&(e.monitorIntervals[i.id]||(e.monitorIntervals[i.id]=0),e.updateLayerAssets(i,"audio")),t.next=19;break;case 16:t.prev=16,t.t0=t.catch(0),console.error("monitorAssets iteration fails ",t.t0);case 19:case"end":return t.stop()}}),t,null,[[0,16]])}))),e.fetchVideo=function(){var e=Object(u.a)(o.a.mark((function e(t){var r,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k()(t,{mode:"no-cors"});case 2:return r=e.sent,e.next=5,r.blob();case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.shouldOptimize=function(t){var r;return"video"===t.type&&(!(!t.mime||!["video/mp4","video/quicktime","video/webm"].includes(t.mime))&&(!t.requireConversion&&(!("pastedLink"!==t.source&&(t.size||0)<=0)&&(!t.optimization_failed&&(!(null===t||void 0===t||null===(r=t.preview)||void 0===r?void 0:r.url)&&(!(!t.optimization_id&&"local"===t.source)&&(!t.mediaLibraryID||!e.pendingOptimizations[t.mediaLibraryID])))))))},e.updateLayerAssets=function(){var t=Object(u.a)(o.a.mark((function t(r){var n,i,s,u,c,d,l,p,b,f,v,m,h,x=arguments;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=x.length>1&&void 0!==x[1]?x[1]:"video",t.prev=1,i=e.props,s=i.addAudio,u=i.updateLayer,c=i.showError,d=i.removeAudio,r){t.next=5;break}return t.abrupt("return");case 5:if(!r.conversion_id||null==r.audioConverted){t.next=19;break}return t.next=8,Object(j.f)(r.conversion_id);case 8:if(l=t.sent,p=Object(a.a)(Object(a.a)({},r),{},{url:l.output_url,asset_id:l.asset_id,conversion_id:null,position:null,audioConverted:!0}),_.g.completed===l.status&&s(p),_.g.failed!==l.status){t.next=19;break}if(console.error("Failed to convert Audio"),Object(S.studioDeleteLayerById)(r.id),!r.mediaLibraryID){t.next=17;break}return t.next=17,O.deletePendingConversion(r.mediaLibraryID);case 17:d(),c("Failed to convert Audio");case 19:if(!r.conversion_id||r.conversion_failed){t.next=22;break}return t.next=22,e.updateLayerConversion(r);case 22:if("audio"!==n){t.next=24;break}return t.abrupt("return");case 24:if(r.mediaLibraryID||(b=y()(),u(r,{mediaLibraryID:b}),r.mediaLibraryID=b),e.confirmUpload(r),e.shouldOptimize(r)&&e.optimizeLayer(r),t.t1=e.monitorIntervals[r.id]>2,!t.t1){t.next=32;break}return t.next=31,e.shouldDownloadVideoBlob(r);case 31:t.t1=t.sent;case 32:if(t.t0=t.t1,!t.t0){t.next=35;break}t.t0=e.numFetchesInProgress<5;case 35:if(!t.t0){t.next=44;break}if(f=e.getDownloadID(r),e.pendingDownloads[f]){t.next=44;break}return e.pendingDownloads[f]=!0,e.numFetchesInProgress+=1,t.next=42,e.downloadVideoBlob(r);case 42:e.numFetchesInProgress-=1,delete e.pendingDownloads[f];case 44:if(e.monitorIntervals[r.id]+=1,!e.isMonitorIntervalForLayer(r)||"pastedLink"!==r.source||!r.asset_id||r.preemptiveDownloadError){t.next=57;break}return t.next=48,Object(D.d)(r.asset_id);case 48:v=t.sent,t.t2=v.status,t.next=t.t2===_.c.uploaded?52:t.t2===_.c.failed?54:56;break;case 52:return u(r,{source:"upload",uploadPending:!1,url:v.url,soundUrl:null}),t.abrupt("break",57);case 54:return r.pastedUrl&&Object(D.f)(r.pastedUrl),t.abrupt("break",57);case 56:return t.abrupt("break",57);case 57:if("pastedLink"!==r.source||"pastedLink"!==r.thumbnail_source||!e.isMonitorIntervalForLayer(r)||!r.thumbnail_asset_id){t.next=62;break}return t.next=60,Object(D.d)(r.thumbnail_asset_id);case 60:(m=t.sent).status===_.c.uploaded&&(h=m.url,u(r,{thumbnail_source:"upload",thumbnailUrl:h}));case 62:t.next=67;break;case 64:t.prev=64,t.t3=t.catch(1),console.warn(t.t3);case 67:case"end":return t.stop()}}),t,null,[[1,64]])})));return function(e){return t.apply(this,arguments)}}(),e.onReupload=function(){var t=Object(u.a)(o.a.mark((function t(r){var i,s,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:console.info("reupload complete for ",r),r.mediaLibraryID&&(e.pendingReuploads[r.mediaLibraryID]=!1),i=e.props,s=i.updateLayer,u=i.scenes,r.mediaLibraryID&&u.forEach((function(e){return e.layers.forEach((function(e){if(e.mediaLibraryID===r.mediaLibraryID){r.id;var t=Object(n.a)(r,["id"]);s(e,Object(a.a)(Object(a.a)({},t),{},{restartUpload:!1}))}}))}));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.optimizeLayer=function(){var t=Object(u.a)(o.a.mark((function t(r){var n,a,i,s,u,c,d,l,p,b,f,v,m,h,y;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.props,a=n.updateLayer,i=n.scenes,s=r.mediaLibraryID){t.next=4;break}return t.abrupt("return");case 4:if(e.pendingOptimizations[s]=!0,t.prev=5,r.optimization_id){t.next=12;break}return t.next=9,Object(j.g)({resource:r.soundUrl||r.url,conversion_type:"optimize-mp4"});case 9:u=t.sent,i.forEach((function(e){return e.layers.forEach((function(e){e.mediaLibraryID===s&&a(e,{optimization_id:u})}))})),r.optimization_id=u;case 12:return t.prev=12,t.next=15,Object(j.f)(r.optimization_id);case 15:c=t.sent,t.next=23;break;case 18:return t.prev=18,t.t0=t.catch(12),console.error("Optimization failed!",t.t0),a(r,{optimization_id:null,optimization_failed:!0}),t.abrupt("return");case 23:if(c){t.next=25;break}throw Error("Failed to optimize, optimization not found");case 25:if(c.status===_.g.failed&&a(r,{optimization_id:null,optimization_failed:!0}),_.g.completed===c.status){t.next=29;break}return delete e.pendingOptimizations[s],t.abrupt("return");case 29:return t.next=31,e.createVideo(c);case 31:return d=t.sent,l=d.width,p=d.height,b=d.duration,f={optimization_id:null,preview:{url:c.output_url,asset_id:c.asset_id,width:l,height:p,duration:b,endTime:b,startTime:0,mediaLibraryID:s}},t.next=38,fetch(f.preview.url);case 38:return v=t.sent,t.next=41,v.blob();case 41:return m=t.sent,h="optimized-".concat(r.name),y=new File([m],h,{type:m.type}),f.local_url=URL.createObjectURL(y),t.next=47,O.getAsset(s,r.source,"Asset Monitor");case 47:if(t.sent){t.next=55;break}return t.next=51,O.addAsset(s,y);case 51:return t.next=53,O.updateAsset(s,{url:f.preview.url,asset_id:c.asset_id,isOptimizedPreview:!0});case 53:t.next=57;break;case 55:return t.next=57,O.updateAsset(s,{optimizedPreviewFile:y});case 57:i.forEach((function(e){return e.layers.forEach((function(e){e.mediaLibraryID===r.mediaLibraryID&&a(e,f)}))})),t.next=63;break;case 60:t.prev=60,t.t1=t.catch(5),console.info("Failed to optimize",t.t1);case 63:delete e.pendingOptimizations[s];case 64:case"end":return t.stop()}}),t,null,[[5,60],[12,18]])})));return function(e){return t.apply(this,arguments)}}(),e.updateLayerConversion=function(){var t=Object(u.a)(o.a.mark((function t(r){var n,a,i,s,c,d,l,p,b,f;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.props,a=n.showError,i=n.updateLayer,s=n.updateUploadStatus,t.prev=1,t.next=4,Object(j.f)(r.conversion_id);case 4:if(c=t.sent){t.next=7;break}throw Error("Failed to convert, conversion not found");case 7:if(c.progress&&r.uploadId&&s(r.uploadId,{conversionProgress:c.progress}),c.status!==_.g.failed){t.next=13;break}throw i(r,{conversion_failed:!0}),Error(c.error||"Failed to convert");case 13:if(c.status!==_.g.started){t.next=15;break}return t.abrupt("return");case 15:return t.next=17,e.createVideo(c);case 17:d=t.sent,l=d.width,p=d.height,b=d.duration,f={url:c.output_url,source:"upload",asset_id:c.asset_id,conversion_id:null,position:null,videoConvertedState:"complete",requireConversion:!1,width:l,height:p,duration:b,endTime:b,startTime:0},r.requireConversion&&r.conversion_type&&r.conversion_type.includes("gif-to")&&(f.type="video",f.mime=Object(U.k)()?"video/quicktime":"video/webm",f.isTrimmed=!1),_.g.completed===c.status&&(fetch(c.output_url).then((function(e){return e.blob()})).then(function(){var e=Object(u.a)(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=new File([t],r.name,{type:t.type}),!r.mediaLibraryID){e.next=8;break}return e.next=4,O.addAsset(r.mediaLibraryID,n);case 4:return e.next=6,O.updateAsset(r.mediaLibraryID,{url:f.url,asset_id:c.asset_id});case 6:return e.next=8,O.deletePendingConversion(r.mediaLibraryID);case 8:i(r,{local_url:URL.createObjectURL(n)});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),r.isMediaLibraryUpload||(i(r,f),e.removePaddingIfUploadedFromOneOff()),e.redirectFromConsolidatedOneoffLandingPageToStudio()),t.next=34;break;case 26:if(t.prev=26,t.t0=t.catch(1),console.error("Failed to convert",t.t0),!r.mediaLibraryID){t.next=32;break}return t.next=32,O.deletePendingConversion(r.mediaLibraryID);case 32:Object(S.studioDeleteLayerById)(r.id),a("Failed to convert");case 34:case"end":return t.stop()}}),t,null,[[1,26]])})));return function(e){return t.apply(this,arguments)}}(),e.createVideo=function(e){return new Promise((function(t,r){var n=document.createElement("video");n.onerror=function(e){return r(e)},n.onloadedmetadata=function(){t({width:n.videoWidth,height:n.videoHeight,duration:n.duration})},n.src=e.output_url}))},e.downloadVideoBlob=function(){var t=Object(u.a)(o.a.mark((function t(r){var n,a,i,s,u,c,d,l;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.props.updateLayer,i=Object(F.a)(r),t.next=4,e.fetchVideo(i);case 4:if(s=t.sent,u=new File([s],r.name,{type:s.type}),c=i===(null===r||void 0===r||null===(n=r.preview)||void 0===n?void 0:n.url),!r.mediaLibraryID){t.next=14;break}return t.next=10,O.addAsset(r.mediaLibraryID,u);case 10:return t.next=12,O.updateAsset(r.mediaLibraryID,{url:i,asset_id:r.asset_id,isOptimizedPreview:c});case 12:d=Object(M.b)(),(0,d.dispatch)(Object(C.a)(r.mediaLibraryID));case 14:l=URL.createObjectURL(u),a(r,{local_url:l});case 16:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.shouldDownloadVideoBlob=function(){var t=Object(u.a)(o.a.mark((function t(r){var n,a,i,s,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.props.updateLayer,!(a=Object(F.a)(r))||a.includes("blob:")||Object(U.f)()||e.assetInDb[a]||"pastedLink"===r.source||["text","shape","subtitle"].includes(r.type)||r.requireConversion||!r.mediaLibraryID||r.isSample||r.emojiDescription){t.next=13;break}return t.next=5,O.getAsset(r.mediaLibraryID,r.source,"Asset Monitor");case 5:if(!(i=t.sent)){t.next=12;break}return s=i.type===g.b.Video&&i.optimizedPreviewFile||i.file,u=URL.createObjectURL(s),e.assetInDb[a]=u,n(r,{local_url:u}),t.abrupt("return",!1);case 12:return t.abrupt("return",!0);case 13:return t.abrupt("return",!1);case 14:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e}return Object(d.a)(r,[{key:"componentDidMount",value:function(){this.intervalId=setInterval(this.monitorAssets,3e3),this.monitorIntervals={},this.pendingDownloads={},this.pendingReuploads={},this.pendingOptimizations={},this.assetInDb={},this.numFetchesInProgress=0,this.checkForPendingUploads()}},{key:"componentWillUnmount",value:function(){clearInterval(this.intervalId)}},{key:"refreshLayerAssets",value:function(){var e=Object(u.a)(o.a.mark((function e(t){var r,n,i,s,u,c,d,l,p,b,f,v,m,h,y;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.props,i=n.scenes,s=n.updateLayer,!t.asset_id){e.next=8;break}return e.next=4,Object(D.d)(t.asset_id);case 4:u=e.sent,c=u.blob_name,d=u.status,l=u.bucket_name,p=u.url,d===_.c.uploaded&&c&&(l||(l=_.l),p||(p="".concat(_.A,"/").concat(l,"/").concat(c)),i.forEach((function(e){return e.layers.forEach((function(e){e.mediaLibraryID===t.mediaLibraryID&&s(e,{url:p,uploadConfirmed:Date.now()})}))})));case 8:if(!(null===t||void 0===t||null===(r=t.preview)||void 0===r?void 0:r.asset_id)){e.next=15;break}return e.next=11,Object(D.d)(null===t||void 0===t||null===(b=t.preview)||void 0===b?void 0:b.asset_id);case 11:f=e.sent,v=f.blob_name,m=f.status,h=f.bucket_name,y=f.url,m===_.c.uploaded&&v&&(h||(h=_.l),y||(y="".concat(_.A,"/").concat(h,"/").concat(v)),i.forEach((function(e){return e.layers.forEach((function(e){e.mediaLibraryID===t.mediaLibraryID&&s(e,{preview:Object(a.a)(Object(a.a)({},e.preview),{},{url:y})})}))})));case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"confirmUpload",value:function(){var e=Object(u.a)(o.a.mark((function e(t){var r,n,a,i,s,u,c,d,l,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=Object(M.b)(),n=r.state.uploadStatuses,a=void 0===n?{}:n,i=this.props,s=i.scenes,u=i.updateLayer,"pastedLink"!==t.source){e.next=4;break}return e.abrupt("return");case 4:if(t.mediaLibraryID){e.next=6;break}return e.abrupt("return");case 6:if(!this.pendingReuploads[t.mediaLibraryID]){e.next=8;break}return e.abrupt("return");case 8:if(this.pendingReuploads[t.mediaLibraryID]=!0,c=!1,d=t.uploadId?a[t.uploadId]:null,"local"!==t.source||t.asset_id||d){e.next=18;break}return e.next=14,O.getAsset(t.mediaLibraryID,t.source,"Asset Monitor Confirm Upload");case 14:e.sent&&(c=!0),e.next=27;break;case 18:if(!t.asset_id||t.isSample||t.uploadConfirmed&&!(Date.now()-t.uploadConfirmed>36e5)){e.next=27;break}return e.prev=19,e.next=22,this.refreshLayerAssets(t);case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(19),c=!0;case 27:if(c){e.next=30;break}return this.pendingReuploads[t.mediaLibraryID]=!1,e.abrupt("return");case 30:return s.forEach((function(e){return e.layers.forEach((function(e){e.mediaLibraryID===t.mediaLibraryID&&u(e,{source:"local"})}))})),e.next=33,O.getAsset(t.mediaLibraryID,t.source,"Asset Monitor");case 33:if(l=e.sent,p=null===l||void 0===l?void 0:l.file){e.next=37;break}return e.abrupt("return");case 37:p.name||(p.name=Object(R.r)()),Object(V.b)(p,t,{eventHandlers:{handleFinish:this.onReupload},uploadOptions:{uploadLocation:"reupload",uploadSourceComponent:"AssetMonitor"}});case 39:case"end":return e.stop()}}),e,this,[[19,24]])})));return function(t){return e.apply(this,arguments)}}()},{key:"getDownloadID",value:function(e){return e.mediaLibraryID||e.id}},{key:"isMonitorIntervalForLayer",value:function(e){return this.monitorIntervals[e.id]%5===1}},{key:"redirectFromConsolidatedOneoffLandingPageToStudio",value:function(){var e=this.props.origin;["mute-video","rotate-video","resize-video"].includes(e)&&Object(E.d)()}},{key:"removePaddingIfUploadedFromOneOff",value:function(){var e=this.props,t=e.layers,r=e.origin;1===(null===t||void 0===t?void 0:t.length)&&["convert-video"].includes(r)&&Object(S.studioRemovePadding)()}},{key:"checkForPendingUploads",value:function(){var e=Object(u.a)(o.a.mark((function e(){var t,r,n,i,u,c,d,l,p,b,f,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.props,r=t.videoId,n=t.updateLayer,i=t.scenes,u={},r&&(u.video_id=r),c=Object(s.a)(i),e.prev=4,c.s();case 6:if((d=c.n()).done){e.next=35;break}l=d.value,p=Object(s.a)(l.layers),e.prev=9,p.s();case 11:if((b=p.n()).done){e.next=25;break}if(!(f=b.value).uploadPending){e.next=23;break}if(f.asset_id||!f.url){e.next=22;break}return e.next=17,Object(D.b)(f.url,u);case 17:v=e.sent,f.asset_id=v._id,Object(R.p)(Object(a.a)(Object(a.a)({},f),{},{uploadPending:!1})),e.next=23;break;case 22:n(f,{uploadPending:!1});case 23:e.next=11;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(9),p.e(e.t0);case 30:return e.prev=30,p.f(),e.finish(30);case 33:e.next=6;break;case 35:e.next=40;break;case 37:e.prev=37,e.t1=e.catch(4),c.e(e.t1);case 40:return e.prev=40,c.f(),e.finish(40);case 43:case"end":return e.stop()}}),e,this,[[4,37,40,43],[9,27,30,33]])})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){return null}}]),r}(f.a.Component),q=Object(v.c)((function(e){var t=e.studio.scenes[e.studio.selectedSceneIndex]||{};return{scenes:e.studio.scenes,isStudio:e.isStudio,videoId:e.studio._id,audio:e.audio,layers:t.layers,origin:e.studio.origin}}),(function(e){return Object(m.b)({addAudio:A.a,updateLayer:w.T,updateMediaLibraryLayer:C.d,showError:P.d,removeAudio:A.f,updateUploadStatus:z.b},e)}));t.default=q(T)}}]);